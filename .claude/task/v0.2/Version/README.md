# 版本管理侧边栏任务规划 v0.2

## 项目目标

实现"版本"侧边栏，采用"活跃工作区 (WIP) + 不可变历史"模型，支持版本快照、回滚和管理功能。

## 设计理念

- **活跃工作区 (WIP)**：固定语义版本 0.0.0，所有编辑操作直接作用于此版本
- **不可变历史**：手动保存时从 WIP 快照为历史版本，支持语义化版本号
- **回滚机制**：直接将历史版本内容覆盖到 WIP
- **关键帧优化**：使用 diff-match-patch 混合存储，节省空间
- **统一组件体系**：使用 HeroUI v3 组件库
- **Material Design 风格**：#3388BB 蓝色主题

## 核心架构

### 版本模型

```
活跃工作区 (WIP)
├── semantic_version: "0.0.0" (固定)
├── is_keyframe: true (始终全量存储)
└── 所有编辑操作直接更新此版本

不可变历史版本
├── semantic_version: "x.y.z" (用户指定)
├── 从 WIP 快照创建
├── 关键帧 + Diff 混合存储
└── 只读，可回滚到 WIP
```

### 存储策略

```
WIP 版本 (0.0.0)
├── 始终为关键帧（全量 XML）
├── autosave/save/导入/手动编辑 → 立即更新 WIP
└── 不参与 Diff 链计算

历史版本 (x.y.z)
├── 手动保存时从 WIP 快照
├── 关键帧 or Diff (自动优化)
│   ├── 差异率 > 70% → 刷新关键帧
│   └── 链深度 > 10 → 刷新关键帧
└── source_version_id → 指向前一个版本
```

## 技术要求

1. ✅ 使用 HeroUI v3 组件库 (Card, Button, Separator 等)
2. ✅ 遵循 Material Design 设计规范
3. ✅ 统一使用 #3388BB 主题色
4. ✅ 统一存储抽象层（SQLite/IndexedDB）
5. 🚀 **新增**：WIP 版本管理逻辑
6. 🚀 **新增**：版本快照和回滚功能
7. 🚀 **新增**：智能版本号推荐
8. 🚀 **新增**：版本时间线可视化

## 里程碑总览

| 里程碑            | 文件                               | 预计耗时 | 状态      | 依赖 | 核心内容                 |
| ----------------- | ---------------------------------- | -------- | --------- | ---- | ------------------------ |
| 1. 存储层增强     | [milestone-1.md](./milestone-1.md) | 60 分钟  | ⏳ 待开始 | 无   | WIP 逻辑、版本快照、回滚 |
| 2. UI 组件开发    | [milestone-2.md](./milestone-2.md) | 75 分钟  | ⏳ 待开始 | 1    | 版本侧边栏组件           |
| 3. 集成到主应用   | [milestone-3.md](./milestone-3.md) | 45 分钟  | ⏳ 待开始 | 1, 2 | 底栏按钮、侧边栏切换     |
| 4. 交互功能实现   | [milestone-4.md](./milestone-4.md) | 60 分钟  | ⏳ 待开始 | 1-3  | 创建版本、回滚、验证     |
| 5. 测试与优化     | [milestone-5.md](./milestone-5.md) | 30 分钟  | ⏳ 待开始 | 1-4  | lint 检查、功能测试      |

**总预计耗时**：约 4.5 小时

## 推荐执行顺序

```
里程碑 1 → 里程碑 2 → 里程碑 3 → 里程碑 4 → 里程碑 5
```

## 环境要求

- ✅ HeroUI v3 (v3.0.0-beta.1) 已安装
- ✅ Tailwind CSS v4 已配置
- ✅ React 19 + Next.js 15
- ✅ TypeScript 支持
- ✅ 统一存储层已实现 (SQLite/IndexedDB)
- ✅ diff-match-patch 已安装
- 🚀 **新增**：需要使用的 HeroUI 组件：Card, Button, Separator, Input, TextField, Label

## 核心功能特性

### 🎯 活跃工作区 (WIP)

- **固定版本号**：0.0.0 永久标识
- **实时更新**：所有 DrawIO 操作立即反映
- **全量存储**：始终为关键帧，不使用 Diff
- **画布状态**：代表用户当前的工作状态

### 📜 不可变历史

- **手动快照**：用户主动保存为历史版本
- **智能版本号**：系统推荐，用户可修改（x.y.z 格式）
- **只读保护**：历史版本不可修改
- **空间优化**：关键帧 + Diff 混合存储

### 🔄 版本回滚

- **直接替换**：将历史版本内容覆盖到 WIP
- **无自动保存**：用户自行决定是否保存当前状态
- **编辑器重载**：触发 DrawIO 编辑器重新加载

### 🧠 智能版本号推荐

- **自动递增**：基于最后一个版本号递增 patch 版本
- **兼容未来**：支持 x.y.z 和 x.y.z.h 格式
- **唯一性验证**：防止版本号重复
- **默认值**：首次创建推荐 1.0.0

## 文件修改清单

### 需要修改的文件 (7 个)

1. **`app/lib/storage/constants.ts`**
   - 添加 WIP_VERSION = "0.0.0" 常量

2. **`app/hooks/useStorageXMLVersions.ts`**
   - 区分 WIP 和历史版本的保存逻辑
   - 新增 `createHistoricalVersion()` 方法
   - 新增 `rollbackToVersion()` 方法
   - 新增 `getRecommendedVersion()` 方法

3. **`app/lib/storage/xml-version-engine.ts`**
   - 调整 `computeVersionPayload()` 支持 WIP 模式

4. **`app/components/BottomBar.tsx`**
   - 添加版本管理按钮（History 图标）

5. **`app/components/UnifiedSidebar.tsx`**
   - `activeSidebar` 类型添加 `"version"`
   - 添加 VersionSidebar 条件渲染

6. **`app/page.tsx`**
   - 添加版本侧边栏状态管理
   - 实现版本侧边栏切换逻辑

7. **`app/styles/layout/sidebar.css`**
   - 可能需要微调样式支持版本侧边栏

### 需要新建的文件 (7 个)

1. **`app/components/VersionSidebar.tsx`**
   - 版本侧边栏主容器组件

2. **`app/components/version/WIPIndicator.tsx`**
   - WIP 状态指示器组件

3. **`app/components/version/VersionTimeline.tsx`**
   - 历史版本时间线组件

4. **`app/components/version/VersionCard.tsx`**
   - 单个版本卡片组件

5. **`app/components/version/CreateVersionDialog.tsx`**
   - 创建版本对话框组件

6. **`app/components/version/index.ts`**
   - 版本组件统一导出

7. **`app/styles/components/version.css`**
   - 版本侧边栏专属样式

## 设计亮点

### 🎯 用户体验提升

1. **WIP 概念清晰** - 用户始终知道当前在编辑什么
2. **版本快照简单** - 点击按钮即可保存当前状态
3. **回滚操作安全** - 直接替换，用户自主控制
4. **版本号智能** - 系统推荐，减少思考负担
5. **时间线可视化** - 清晰展示版本演进历史

### 🛠️ 开发者体验

- **存储层解耦**：WIP 逻辑独立，易于维护
- **类型安全**：完整的 TypeScript 类型定义
- **组件化设计**：易于测试和扩展
- **性能优化**：Diff 存储节省空间

## 快速开始

### 开发流程

```bash
# 1. 启动开发服务器
pnpm run dev

# 2. 打开版本侧边栏
# 点击底栏的版本管理按钮

# 3. 观察功能
# - WIP 状态指示器
# - 历史版本时间线
# - 创建版本功能
# - 版本回滚功能
```

### 测试检查点

```bash
# 1. WIP 版本
✓ 编辑 DrawIO 后 WIP 实时更新
✓ WIP 固定显示为 0.0.0
✓ WIP 指示器显示未保存状态

# 2. 创建版本
✓ 点击"保存为新版本"按钮
✓ 智能推荐版本号
✓ 输入描述信息
✓ 验证版本号格式

# 3. 版本时间线
✓ 显示所有历史版本
✓ 标记关键帧/Diff 版本
✓ 显示创建时间
✓ 按时间倒序排列

# 4. 版本回滚
✓ 点击版本卡片的"回滚"按钮
✓ WIP 内容被历史版本覆盖
✓ 编辑器重新加载
✓ 用户可继续编辑
```

## 注意事项

### ⚠️ WIP 版本特性

- **固定版本号**：0.0.0 是系统保留版本号
- **始终全量存储**：不参与 Diff 链计算
- **唯一性**：每个项目只有一个 WIP 版本
- **实时更新**：所有编辑操作立即生效

### 🎯 版本号规范

- **当前支持**：x.y.z 格式（如 1.0.0）
- **未来兼容**：x.y.z.h 格式（如 1.0.0.1）
- **验证规则**：正则表达式 `^\d+\.\d+\.\d+$`
- **唯一性**：不允许与已有版本号重复

### 📦 存储优化

- **WIP 版本**：始终全量存储（is_keyframe=true）
- **历史版本**：关键帧 + Diff 混合
- **刷新条件**：差异率 > 70% 或链深度 > 10
- **空间节省**：大幅减少存储占用

### 🔄 回滚行为

- **直接替换**：不创建新版本
- **用户控制**：回滚后用户决定是否保存
- **编辑器重载**：确保界面与数据同步
- **无确认对话框**：操作简洁高效

## 预期效果

### 优化前

- ❌ 版本管理功能缺失
- ❌ 无法回溯历史状态
- ❌ 无版本可视化界面
- ❌ 无版本号管理

### 优化后

- ✨ WIP 概念清晰可见
- ✨ 支持手动版本快照
- ✨ 支持版本回滚
- ✨ 智能版本号推荐
- ✨ 版本时间线可视化
- ✨ 关键帧 + Diff 优化存储
- ✨ Material Design 风格界面

---

## 项目状态

**⏳ 版本管理侧边栏 v0.2 待开始**

**目标成果**：

- 🎨 WIP + 不可变历史版本模型
- 🔧 版本快照和回滚功能
- 🔍 智能版本号推荐
- ✨ 版本时间线可视化
- 🎯 Material Design 风格界面

---

_创建时间: 2025-01-11_
_版本: v0.2_
_状态: ⏳ 待开始_
