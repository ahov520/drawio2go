# 里程碑 5：测试与优化

**状态**：⏳ 待开始
**预计耗时**：30 分钟
**依赖**：里程碑 1, 2, 3, 4

## 目标

全面测试版本管理功能，修复发现的问题，优化性能和用户体验。

## 任务清单

### 1. 运行 lint 检查

- [ ] 执行 ESLint 和 TypeScript 类型检查：

```bash
# 运行 lint 检查
pnpm lint

# 如果有错误，修复所有类型错误和 ESLint 警告
# 常见问题：
# - 未使用的导入
# - 类型定义缺失
# - React Hooks 依赖项警告
# - 变量未使用警告
```

- [ ] 修复所有发现的问题：
  - 类型错误
  - ESLint 警告
  - React Hooks 依赖项问题

### 2. 功能完整性测试

#### 2.1 WIP 版本功能

- [ ] **测试 WIP 版本初始化**
  ```
  测试步骤：
  1. 创建新项目
  2. 查看数据库（使用浏览器开发者工具或 DB 工具）
  3. 验证：存在 semantic_version="0.0.0" 的版本
  4. 验证：is_keyframe=true
  5. 验证：source_version_id=ZERO_SOURCE_VERSION_ID
  ```

- [ ] **测试 WIP 实时更新**
  ```
  测试步骤：
  1. 在 DrawIO 中绘制图形
  2. 触发保存（Ctrl+S 或自动保存）
  3. 查看数据库
  4. 验证：WIP 版本的 xml_content 已更新
  5. 验证：created_at 时间戳已更新
  6. 打开版本侧边栏
  7. 验证：WIP 指示器显示最新时间
  ```

- [ ] **测试 WIP 版本唯一性**
  ```
  测试步骤：
  1. 多次保存编辑内容
  2. 查看数据库
  3. 验证：只有一个 semantic_version="0.0.0" 的版本
  4. 验证：版本内容是最新的
  ```

#### 2.2 历史版本功能

- [ ] **测试创建历史版本**
  ```
  测试步骤：
  1. 打开版本侧边栏
  2. 点击"保存版本"按钮
  3. 输入版本号 "1.0.0"
  4. 输入描述 "首个版本"
  5. 点击"创建版本"
  6. 验证：对话框关闭
  7. 验证：版本列表显示新版本
  8. 查看数据库
  9. 验证：新版本的 xml_content 与当时的 WIP 一致
  10. 验证：source_version_id 指向前一个版本（或 ZERO_UUID）
  ```

- [ ] **测试智能版本号推荐**
  ```
  测试步骤：
  1. 创建版本 "1.0.0"
  2. 打开创建版本对话框
  3. 验证：推荐版本号为 "1.0.1"
  4. 创建版本 "1.0.1"
  5. 再次打开对话框
  6. 验证：推荐版本号为 "1.0.2"
  7. 手动创建版本 "2.0.0"
  8. 再次打开对话框
  9. 验证：推荐版本号为 "2.0.1"
  ```

- [ ] **测试版本号验证**
  ```
  测试步骤：
  1. 打开创建版本对话框
  2. 输入 "abc" → 验证：显示格式错误
  3. 输入 "1.0" → 验证：显示格式错误
  4. 输入 "0.0.0" → 验证：显示保留版本号错误
  5. 输入已存在的版本号 → 验证：显示版本号已存在
  6. 输入 "1.0.0" → 验证：通过验证
  7. 输入 "1.0.0.1" → 验证：通过验证（未来格式）
  ```

#### 2.3 版本回滚功能

- [ ] **测试基本回滚**
  ```
  测试步骤：
  1. 在 DrawIO 中绘制矩形
  2. 创建版本 "1.0.0"
  3. 继续绘制圆形
  4. 创建版本 "1.1.0"
  5. 继续绘制三角形（不保存版本）
  6. 点击版本 "1.0.0" 的"回滚"按钮
  7. 验证：编辑器只显示矩形（圆形和三角形消失）
  8. 验证：WIP 版本内容被更新为矩形
  9. 验证：版本列表仍保留 "1.0.0" 和 "1.1.0"
  ```

- [ ] **测试回滚后继续编辑**
  ```
  测试步骤：
  1. 回滚到某个历史版本
  2. 在 DrawIO 中继续编辑
  3. 保存
  4. 验证：WIP 版本内容是回滚后的内容 + 新编辑
  5. 验证：历史版本保持不变
  ```

#### 2.4 版本时间线功能

- [ ] **测试版本排序**
  ```
  测试步骤：
  1. 创建版本 "1.0.0"（等待 1 秒）
  2. 创建版本 "1.1.0"（等待 1 秒）
  3. 创建版本 "2.0.0"
  4. 验证：版本列表按时间倒序显示
  5. 验证：最新版本显示"最新"标签
  ```

- [ ] **测试关键帧和 Diff 标记**
  ```
  测试步骤：
  1. 创建多个版本
  2. 查看数据库中的 is_keyframe 字段
  3. 验证：关键帧版本显示 Key 图标和"关键帧"标签
  4. 验证：Diff 版本显示 GitBranch 图标和链深度
  ```

### 3. 边界情况测试

- [ ] **测试无项目状态**
  ```
  测试步骤：
  1. 未选择项目时打开版本侧边栏
  2. 验证：显示"请先选择一个项目"提示
  3. 验证：不崩溃，不报错
  ```

- [ ] **测试空版本列表**
  ```
  测试步骤：
  1. 创建新项目（只有 WIP，无历史版本）
  2. 打开版本侧边栏
  3. 验证：WIP 指示器正常显示
  4. 验证：历史版本区域显示"暂无历史版本"提示
  ```

- [ ] **测试快速连续操作**
  ```
  测试步骤：
  1. 快速点击多次"保存版本"按钮
  2. 验证：对话框只打开一次
  3. 快速创建多个版本（不等待上一个完成）
  4. 验证：所有版本都成功创建，无重复
  ```

- [ ] **测试项目切换**
  ```
  测试步骤：
  1. 打开项目 A 的版本侧边栏
  2. 创建版本 "1.0.0"
  3. 切换到项目 B
  4. 验证：版本侧边栏显示项目 B 的版本
  5. 验证：不显示项目 A 的版本
  6. 切换回项目 A
  7. 验证：版本侧边栏显示项目 A 的版本（包括 "1.0.0"）
  ```

### 4. 性能测试

- [ ] **测试大量版本加载**
  ```
  测试步骤：
  1. 使用脚本创建 50 个版本
  2. 打开版本侧边栏
  3. 验证：版本列表流畅加载
  4. 验证：滚动性能良好
  5. 测量：首次加载时间 < 2 秒
  ```

- [ ] **测试大型 XML 文件**
  ```
  测试步骤：
  1. 绘制复杂图形（100+ 个元素）
  2. 保存到 WIP
  3. 创建历史版本
  4. 验证：保存时间 < 1 秒
  5. 验证：回滚时间 < 1 秒
  6. 验证：编辑器加载时间 < 2 秒
  ```

- [ ] **测试 Diff 存储优化**
  ```
  测试步骤：
  1. 创建基准版本 "1.0.0"（复杂图形）
  2. 微调图形（移动一个元素）
  3. 创建版本 "1.0.1"
  4. 查看数据库
  5. 验证："1.0.1" 是 Diff 版本（不是关键帧）
  6. 验证：xml_content 长度远小于 "1.0.0"
  7. 大幅修改图形（删除 70% 元素）
  8. 创建版本 "1.1.0"
  9. 验证："1.1.0" 刷新为关键帧（差异率 > 70%）
  ```

### 5. 用户体验优化

- [ ] **优化加载状态**
  ```
  优化点：
  - 版本列表加载时显示骨架屏或 Spinner
  - 创建版本时按钮显示"创建中..."
  - 回滚版本时显示加载指示器
  ```

- [ ] **优化错误提示**
  ```
  优化点：
  - 错误提示使用友好的语言
  - 提供具体的错误原因
  - 提供解决方案或重试按钮
  ```

- [ ] **优化动画效果**
  ```
  优化点：
  - 对话框淡入/滑入动画
  - 版本卡片 hover 悬浮效果
  - 版本列表刷新时平滑过渡
  - 所有动画使用 ease-out-cubic 缓动
  ```

- [ ] **优化响应式布局**
  ```
  测试宽度：
  - 300px（最小宽度）
  - 500px（中等宽度）
  - 800px（最大宽度）
  验证：
  - 所有内容正确显示
  - 按钮和文字不重叠
  - 滚动条正常工作
  ```

### 6. 代码质量优化

- [ ] **重构长方法**
  ```
  检查点：
  - 单个方法不超过 50 行
  - 复杂逻辑提取为独立函数
  - 避免嵌套超过 3 层
  ```

- [ ] **添加注释**
  ```
  注释要求：
  - 所有公共方法有 JSDoc 注释
  - 复杂逻辑有行内注释
  - 关键算法有说明注释
  ```

- [ ] **统一命名规范**
  ```
  检查点：
  - 组件名使用 PascalCase
  - 函数名使用 camelCase
  - 常量名使用 UPPER_SNAKE_CASE
  - CSS 类名使用 kebab-case
  ```

- [ ] **移除调试代码**
  ```
  检查点：
  - 移除所有 console.log（保留必要的错误日志）
  - 移除注释掉的代码
  - 移除 TODO 注释（转为 Issue）
  ```

### 7. 文档完善

- [ ] **更新 AGENTS.md**
  ```
  更新内容：
  - 添加版本管理功能说明
  - 更新文件结构
  - 添加 WIP 版本模型说明
  - 更新最近更新日志
  ```

- [ ] **添加组件文档**（可选）
  ```
  创建文件：
  - app/components/version/README.md
  内容：
  - 组件使用说明
  - Props 接口说明
  - 使用示例
  ```

### 8. 最终验收测试

- [ ] **完整用户流程测试**
  ```
  场景 1：新用户首次使用
  1. 创建新项目
  2. 绘制简单图形
  3. 保存
  4. 打开版本侧边栏
  5. 查看 WIP 版本
  6. 创建第一个历史版本
  7. 继续编辑
  8. 回滚到之前的版本
  9. 再次编辑并保存

  场景 2：老用户日常使用
  1. 打开现有项目
  2. 查看版本历史
  3. 回滚到某个版本
  4. 基于该版本继续开发
  5. 创建新版本
  6. 切换到另一个项目
  7. 重复版本管理操作
  ```

- [ ] **跨浏览器测试**（如果适用）
  ```
  测试浏览器：
  - Chrome（主要）
  - Firefox
  - Safari
  - Edge

  测试点：
  - 基本功能正常
  - 样式显示正确
  - 动画效果流畅
  - IndexedDB 正常工作
  ```

- [ ] **Electron 环境测试**
  ```
  测试点：
  - SQLite 存储正常工作
  - 所有功能在桌面应用中正常
  - 性能符合预期
  - 无控制台错误
  ```

## 验收标准

- [ ] 所有 lint 检查通过，无错误和警告
- [ ] 所有功能测试用例通过
- [ ] 所有边界情况正确处理
- [ ] 性能指标达标（加载 < 2s，操作 < 1s）
- [ ] 用户体验流畅，无明显卡顿
- [ ] 代码质量良好，易于维护
- [ ] 文档完善，便于后续开发
- [ ] 无控制台错误或警告

## 测试报告模板

测试完成后，填写以下报告：

```markdown
# 版本管理功能测试报告

## 测试环境
- 操作系统: [Windows/macOS/Linux]
- 浏览器: [Chrome/Firefox/etc]
- Node 版本: [版本号]
- 测试日期: [日期]

## 功能测试结果

### WIP 版本功能
- [ ] 初始化测试：✅ 通过 / ❌ 失败
- [ ] 实时更新测试：✅ 通过 / ❌ 失败
- [ ] 唯一性测试：✅ 通过 / ❌ 失败

### 历史版本功能
- [ ] 创建版本测试：✅ 通过 / ❌ 失败
- [ ] 版本号推荐测试：✅ 通过 / ❌ 失败
- [ ] 版本号验证测试：✅ 通过 / ❌ 失败

### 版本回滚功能
- [ ] 基本回滚测试：✅ 通过 / ❌ 失败
- [ ] 回滚后编辑测试：✅ 通过 / ❌ 失败

### 版本时间线功能
- [ ] 版本排序测试：✅ 通过 / ❌ 失败
- [ ] 标记显示测试：✅ 通过 / ❌ 失败

## 性能测试结果

| 测试项           | 目标    | 实际   | 结果 |
| ---------------- | ------- | ------ | ---- |
| 版本列表加载     | < 2s    | [实际] | ✅/❌ |
| 创建版本         | < 1s    | [实际] | ✅/❌ |
| 版本回滚         | < 1s    | [实际] | ✅/❌ |
| 编辑器重载       | < 2s    | [实际] | ✅/❌ |
| 50 个版本滚动    | 流畅    | [实际] | ✅/❌ |

## 发现的问题

1. [问题描述]
   - 严重程度：高/中/低
   - 重现步骤：...
   - 预期结果：...
   - 实际结果：...

2. [问题描述]
   ...

## 优化建议

1. [建议内容]
2. [建议内容]

## 总结

- 通过测试项：[X]/[总数]
- 功能完整性：✅ 完整 / ⚠️ 部分完成 / ❌ 不完整
- 性能表现：✅ 优秀 / ⚠️ 良好 / ❌ 需优化
- 用户体验：✅ 优秀 / ⚠️ 良好 / ❌ 需改进
- 代码质量：✅ 优秀 / ⚠️ 良好 / ❌ 需重构

## 结论

[功能是否可以发布，或需要哪些改进]
```

## 常见问题及解决方案

### 问题 1：lint 报错 "React Hook useEffect has missing dependencies"

**解决方案**：
```typescript
// 方案 1：添加缺失的依赖
useEffect(() => {
  // ...
}, [dependency1, dependency2]); // 添加所有使用的变量

// 方案 2：如果依赖会导致无限循环，使用 useCallback 包裹函数
const handleSomething = useCallback(() => {
  // ...
}, []);

useEffect(() => {
  handleSomething();
}, [handleSomething]);
```

### 问题 2：版本回滚后编辑器未更新

**解决方案**：
```typescript
// 确保调用 replaceWithXml 时传入 true 强制重载
await replaceWithXml(xml, true);

// 如果还不行，尝试延迟加载
setTimeout(() => {
  replaceWithXml(xml, true);
}, 100);
```

### 问题 3：版本列表不更新

**解决方案**：
```typescript
// 确保触发了自定义事件
window.dispatchEvent(new Event('version-updated'));

// 确保组件监听了该事件
useEffect(() => {
  const handler = () => {
    loadVersions();
  };
  window.addEventListener('version-updated', handler);
  return () => window.removeEventListener('version-updated', handler);
}, [loadVersions]);
```

### 问题 4：对话框关闭后状态未重置

**解决方案**：
```typescript
// 在 onClose 中重置所有状态
const handleClose = () => {
  setVersionNumber('');
  setDescription('');
  setError('');
  setValidationError('');
  onClose();
};
```

## 优化检查清单

- [ ] 所有图片/图标使用懒加载
- [ ] 长列表使用虚拟滚动（如需要）
- [ ] 防抖/节流应用于频繁操作
- [ ] 避免不必要的重渲染（使用 React.memo）
- [ ] 大型计算使用 useMemo
- [ ] 事件处理使用 useCallback
- [ ] 清理所有副作用（事件监听、定时器）
- [ ] 避免内存泄漏（取消未完成的请求）

---

**完成标志**：所有测试通过，性能达标，代码质量优秀，文档完善。

**🎉 恭喜！版本管理功能开发完成！**
