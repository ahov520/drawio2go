# M10: 测试验证

## 目标

全面测试国际化功能，确保所有文本正确翻译、语言切换流畅、在不同环境下正常运行，并修复发现的问题。

## 预估时间

2-3 小时

## 前置依赖

- M1-M9 全部完成

## 任务清单

### 10.1 功能测试

#### 语言切换功能

**测试步骤**:
1. 启动应用（`pnpm run dev`）
2. 打开设置侧边栏 → 通用设置
3. 点击语言切换器，选择英语
4. 验证：
   - [ ] 界面文本立即更新为英文
   - [ ] localStorage 中 `drawio2go-language` 值为 `en-US`
5. 刷新页面
6. 验证：
   - [ ] 页面以英语显示
   - [ ] 语言选择保持为英语
7. 切换回简体中文
8. 验证：
   - [ ] 界面文本立即更新为中文
   - [ ] localStorage 更新为 `zh-CN`

#### 首次访问语言检测

**测试步骤**:
1. 清除 localStorage（`localStorage.removeItem('drawio2go-language')`）
2. 刷新页面
3. 验证：
   - [ ] 如果系统语言为中文，界面显示中文
   - [ ] 如果系统语言为英文或其他，界面显示英文（默认）

#### HTML lang 属性更新

**测试步骤**:
1. 打开浏览器开发者工具
2. 切换语言
3. 检查 `<html>` 标签的 `lang` 属性
4. 验证：
   - [ ] 英语时 `lang="en-US"`
   - [ ] 中文时 `lang="zh-CN"`

### 10.2 UI 文本测试

#### TopBar 组件

- [ ] 选区信息文本国际化
- [ ] 加载、保存按钮文本国际化
- [ ] Aria 标签国际化

#### ProjectSelector 组件

- [ ] 表单标签国际化
- [ ] 按钮文本国际化
- [ ] 空状态提示国际化
- [ ] 验证错误消息国际化

#### UnifiedSidebar 组件

- [ ] Tab 标签（聊天、设置、版本）国际化

#### 聊天模块

- [ ] 空状态提示国际化
- [ ] 消息时间戳国际化
- [ ] 工具调用状态国际化
- [ ] 输入框占位符国际化
- [ ] 会话列表国际化

#### 设置模块

- [ ] 通用设置面板完全国际化
- [ ] LLM 设置面板国际化
- [ ] 版本设置面板国际化
- [ ] 表单验证消息国际化

#### 版本管理模块

- [ ] 版本卡片国际化
- [ ] 版本时间线国际化
- [ ] 版本对比视图国际化
- [ ] 创建版本对话框国际化

### 10.3 日期和数字测试

#### 日期格式化

**英语格式**:
- [ ] 完整日期时间：`12/25/2024, 3:45 PM`
- [ ] 紧凑日期：`12/25/24`

**中文格式**:
- [ ] 完整日期时间：`2024/12/25 15:45`
- [ ] 紧凑日期：`2024/12/25`

#### 相对时间

**英语**:
- [ ] "Just now"
- [ ] "2 minutes ago"
- [ ] "5 hours ago"
- [ ] "3 days ago"

**中文**:
- [ ] "刚刚"
- [ ] "2 分钟前"
- [ ] "5 小时前"
- [ ] "3 天前"

#### 数字格式化

- [ ] 文件大小显示正确（如 "8.5 MB"）
- [ ] 百分比显示正确（如 "85.7%"）
- [ ] 千位分隔符符合语言习惯

### 10.4 错误消息测试

#### 存储层错误

**测试步骤**:
1. 触发验证错误（如无效的 page_count）
2. 切换到英语
3. 验证：
   - [ ] 错误消息为英文
4. 切换到中文
5. 验证：
   - [ ] 错误消息为中文

#### API 错误

**测试步骤**:
1. 发送缺少参数的聊天请求
2. 验证：
   - [ ] 错误响应根据当前语言返回

#### 表单验证错误

**测试步骤**:
1. 在创建版本对话框中输入无效数据
2. 切换语言
3. 验证：
   - [ ] 验证错误消息根据语言显示

### 10.5 Electron 环境测试

**测试步骤**:
1. 运行 `pnpm run electron:dev`
2. 在 Electron 应用中测试所有功能
3. 验证：
   - [ ] 语言切换正常
   - [ ] 所有文本国际化
   - [ ] 日期格式正确
   - [ ] localStorage 持久化工作

### 10.6 代码质量检查

#### 检查未翻译的中文

**命令**:
```bash
grep -r "[\u4e00-\u9fa5]" app/components --include="*.tsx" -n
grep -r "[\u4e00-\u9fa5]" app/lib --include="*.ts" -n
grep -r "[\u4e00-\u9fa5]" app/api --include="*.ts" -n
```

**验证**:
- [ ] 仅在注释中存在中文
- [ ] 所有 UI 文本已国际化

#### TypeScript 类型检查

**命令**:
```bash
pnpm run lint
```

**验证**:
- [ ] 无 TypeScript 错误
- [ ] 无 ESLint 错误

#### JSON 格式验证

**命令**:
```bash
find locales -name "*.json" -exec jq empty {} \;
```

**验证**:
- [ ] 所有 JSON 文件格式正确

### 10.7 翻译资源完整性检查

#### 键值对齐检查

**手动检查**:
1. 对比 `locales/en-US/*.json` 和 `locales/zh-CN/*.json`
2. 验证：
   - [ ] 键名完全一致
   - [ ] 嵌套结构一致
   - [ ] 插值变量一致

**自动检查脚本**（可选）:
```bash
# 创建简单的检查脚本
node -e "
const fs = require('fs');
const files = ['common', 'topbar', 'sidebar', 'chat', 'settings', 'version', 'project', 'errors', 'validation'];
files.forEach(file => {
  const en = require('./locales/en-US/' + file + '.json');
  const zh = require('./locales/zh-CN/' + file + '.json');
  const enKeys = JSON.stringify(Object.keys(en).sort());
  const zhKeys = JSON.stringify(Object.keys(zh).sort());
  if (enKeys !== zhKeys) {
    console.error('Mismatch in ' + file + '.json');
  } else {
    console.log(file + '.json: OK');
  }
});
"
```

### 10.8 性能测试

#### 首屏加载

**测试步骤**:
1. 打开浏览器开发者工具 Network 面板
2. 刷新页面
3. 验证：
   - [ ] 翻译资源加载快速（< 100ms）
   - [ ] 总包体积合理（< 50KB）

#### 语言切换性能

**测试步骤**:
1. 打开浏览器开发者工具 Performance 面板
2. 开始录制
3. 切换语言
4. 停止录制
5. 验证：
   - [ ] 切换响应快速（< 200ms）
   - [ ] 无明显卡顿

### 10.9 可访问性测试

#### Aria 标签验证

**测试步骤**:
1. 使用浏览器开发者工具检查 Aria 属性
2. 验证：
   - [ ] 所有图标按钮有 `aria-label`
   - [ ] Aria 标签根据语言更新
   - [ ] 表单控件有正确的 `aria-describedby`

#### 屏幕阅读器测试（可选）

**测试步骤**:
1. 启用屏幕阅读器（如 NVDA、JAWS）
2. 切换语言
3. 验证：
   - [ ] Aria 标签以正确语言朗读

## 问题修复

### 常见问题清单

#### 问题 1: 翻译不显示

**症状**: 切换语言后文本不变

**检查**:
- [ ] 组件是否使用了 `useTranslation` Hook
- [ ] 翻译键值是否正确
- [ ] JSON 文件是否有语法错误

#### 问题 2: 刷新后语言重置

**症状**: 刷新页面后回到默认语言

**检查**:
- [ ] localStorage 是否正确写入
- [ ] 语言检测器配置是否正确
- [ ] 浏览器是否禁用 localStorage

#### 问题 3: 插值变量不显示

**症状**: 翻译显示为 `{{variableName}}`

**检查**:
- [ ] `t()` 函数是否传递了变量对象
- [ ] 变量名是否拼写正确
- [ ] 变量值是否为 undefined

#### 问题 4: 部分文本未翻译

**症状**: 部分文本仍为中文

**检查**:
- [ ] 运行 grep 检查是否有遗漏
- [ ] 组件是否导入了 `useTranslation`
- [ ] 翻译键值是否已添加

#### 问题 5: 日期格式不正确

**症状**: 日期格式不符合预期

**检查**:
- [ ] `formatVersionTimestamp` 是否传递了 `locale` 参数
- [ ] `getCurrentLocale()` 是否返回正确值
- [ ] `Intl.DateTimeFormatOptions` 配置是否正确

## 验收标准

### 功能完整性

- [ ] 所有 UI 文本已国际化
- [ ] 语言切换流畅无延迟
- [ ] 语言选择持久化
- [ ] 日期格式符合语言习惯
- [ ] 错误消息根据语言显示
- [ ] Aria 标签国际化

### 代码质量

- [ ] 无中文硬编码（除注释）
- [ ] 无 TypeScript 错误
- [ ] 无 ESLint 警告
- [ ] JSON 文件格式正确
- [ ] 翻译资源完整对齐

### 跨环境兼容

- [ ] Web 环境正常
- [ ] Electron 环境正常
- [ ] 不同浏览器兼容（Chrome、Firefox、Safari）

### 性能

- [ ] 首屏加载快速
- [ ] 语言切换流畅
- [ ] 翻译资源体积合理

## 最终检查清单

在提交前，确保完成以下所有项：

**配置和基础设施**:
- [ ] 依赖包已安装
- [ ] i18n 配置文件已创建
- [ ] 翻译资源目录结构正确

**翻译资源**:
- [ ] 18 个 JSON 文件已创建
- [ ] 约 435 条翻译已完成
- [ ] 中英文翻译数量一致
- [ ] JSON 格式正确

**组件改造**:
- [ ] TopBar 组件国际化
- [ ] ProjectSelector 组件国际化
- [ ] UnifiedSidebar 组件国际化
- [ ] 聊天组件系列国际化
- [ ] 设置组件系列国际化
- [ ] 版本管理组件系列国际化

**功能验证**:
- [ ] 语言切换功能正常
- [ ] 语言检测正确
- [ ] 日期格式化正确
- [ ] 错误消息国际化
- [ ] Electron 环境测试通过

**代码质量**:
- [ ] `pnpm run lint` 无错误
- [ ] 无中文硬编码
- [ ] TypeScript 类型正确

## 文档更新

完成测试后，更新项目文档：

**更新 `AGENTS.md`**:
在适当位置添加国际化章节，说明：
- 如何使用 i18n
- 翻译资源组织方式
- 如何添加新语言
- 如何添加新翻译键值

**创建 `locales/README.md`**（可选）:
提供翻译贡献指南，包括：
- 翻译规范
- 命名约定
- 如何添加新语言
- 如何验证翻译

## 完成标志

当所有验收标准通过后，国际化任务完成。此时：
1. 应用支持完整的中英文切换
2. 所有界面文本、日期、错误消息已国际化
3. 语言切换流畅，用户体验良好
4. 代码质量符合项目标准
5. 在 Web 和 Electron 环境下正常运行

恭喜！DrawIO2Go 国际化改造完成！🎉
