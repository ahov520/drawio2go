# 里程碑 6：集成测试与调试

**状态**：⏸️ 待执行
**预计耗时**：90 分钟
**依赖**：里程碑 1-5

## 目标
端到端测试整个 Agent Loop 流程，确保所有功能正常工作

## 测试前准备

### 环境检查
- [ ] 确认已完成前 5 个里程碑
- [ ] 运行 `pnpm run dev` 启动开发服务器
- [ ] 打开 Chrome DevTools
- [ ] 准备一个有效的 API Key（DeepSeek 或 OpenAI）

### 配置设置
- [ ] 打开应用设置侧边栏
- [ ] 配置以下参数：
  - API 地址：`https://api.deepseek.com`
  - API Key：输入有效密钥
  - 模型名称：`deepseek-chat`
  - 温度：`0.3`
  - 最大工具调用轮次：`5`
  - 使用旧式 OpenAI 格式：勾选
- [ ] 保存配置

---

## 测试场景

### 场景 1：基础对话测试
**目标**：验证基本聊天功能

- [ ] 打开聊天侧边栏
- [ ] 发送消息："你好，介绍一下你自己"
- [ ] **预期结果**：
  - AI 正常回复
  - 无工具调用
  - 消息显示正确
  - 无控制台错误

### 场景 2：单次工具调用测试
**目标**：验证单个工具调用流程

- [ ] 发送消息："获取当前图表的 XML 内容"
- [ ] **预期结果**：
  - 出现工具调用卡片
  - 工具名称：`get_drawio_xml`
  - 工具状态：执行中 → 完成
  - 显示工具结果（XML 内容或错误信息）
  - AI 生成总结性回复

- [ ] **检查点**：
  - [ ] 工具卡片样式正确
  - [ ] 参数区域显示正确（无参数时显示空对象）
  - [ ] 结果区域显示正确（JSON 格式）
  - [ ] 状态图标正确（✓ 完成）

### 场景 3：多次工具调用测试（链式调用）
**目标**：验证多轮工具调用和推理循环

**前提**：确保 localStorage 中有一个 DrawIO 图表

- [ ] 发送消息："将图表中的所有文本转换为大写"
- [ ] **预期流程**：
  1. AI 调用 `get_drawio_xml` 获取当前 XML
  2. AI 分析 XML 内容
  3. AI 调用 `batch_replace_drawio_xml` 执行替换
  4. AI 确认完成并回复

- [ ] **预期结果**：
  - 显示至少 2 个工具调用卡片
  - 每个工具调用都有清晰的参数和结果
  - AI 最终给出总结性回复
  - 图表实际被修改（可刷新 DrawIO 编辑器验证）

- [ ] **检查点**：
  - [ ] 工具调用顺序符合逻辑
  - [ ] 第二次调用使用了第一次的结果
  - [ ] 所有工具状态都变为"完成"
  - [ ] 无工具执行错误

### 场景 4：批量替换工具测试
**目标**：测试批量替换功能

- [ ] 发送消息："将图表中的 'oldText' 替换为 'newText'，同时将 'foo' 替换为 'bar'"
- [ ] **预期结果**：
  - AI 调用 `batch_replace_drawio_xml`
  - 参数包含 `replacements` 数组（2 个替换对）
  - 结果显示成功数量和跳过数量
  - 如果某些内容不存在或不唯一，结果中包含错误详情

- [ ] **检查点**：
  - [ ] 替换对格式正确
  - [ ] 成功/跳过计数准确
  - [ ] 错误信息清晰（如果有）

### 场景 5：最大循环限制测试
**目标**：验证最大循环次数限制

- [ ] 修改设置，将"最大工具调用轮次"设为 `2`
- [ ] 保存配置
- [ ] 发送复杂请求："获取 XML，然后分析它，再修改它，最后总结你做了什么"
- [ ] **预期结果**：
  - 最多显示 2 个工具调用
  - AI 在达到限制后停止
  - AI 可能提示"达到最大调用次数"

- [ ] **检查点**：
  - [ ] 工具调用不超过 2 次
  - [ ] 无无限循环
  - [ ] 用户得到合理的反馈

### 场景 6：工具执行失败测试
**目标**：测试错误处理

- [ ] 清空 localStorage（模拟无图表数据）：
  ```javascript
  localStorage.removeItem('currentDiagram');
  ```
- [ ] 发送消息："获取当前图表的 XML"
- [ ] **预期结果**：
  - 工具调用失败
  - 结果中显示错误信息："未找到保存的图表数据"
  - AI 根据错误给出提示

- [ ] **检查点**：
  - [ ] 错误信息清晰
  - [ ] 应用不崩溃
  - [ ] AI 能理解错误并回复

### 场景 7：API 错误测试
**目标**：测试 API 层错误处理

- [ ] 修改设置，使用无效的 API Key
- [ ] 保存配置
- [ ] 发送任意消息
- [ ] **预期结果**：
  - 显示错误横幅
  - 错误消息友好（如"API 密钥无效"）
  - 提供刷新页面按钮

- [ ] **检查点**：
  - [ ] 错误横幅显示正确
  - [ ] 错误消息具体
  - [ ] 刷新按钮可用

### 场景 8：Provider 切换测试
**目标**：验证 DeepSeek/OpenAI 切换

**DeepSeek 模式**：
- [ ] 设置勾选"使用旧式 OpenAI 格式"
- [ ] 配置：
  - API 地址：`https://api.deepseek.com`
  - 模型：`deepseek-chat`
- [ ] 发送消息并验证正常工作

**OpenAI 模式**：
- [ ] 设置取消勾选"使用旧式 OpenAI 格式"
- [ ] 配置：
  - API 地址：`https://api.openai.com/v1`
  - 模型：`gpt-4o-mini`
- [ ] 发送消息并验证正常工作

- [ ] **检查点**：
  - [ ] 两种模式都能正常工作
  - [ ] 切换时无报错
  - [ ] 工具调用在两种模式下都正常

### 场景 9：流式响应测试
**目标**：验证流式输出

- [ ] 发送较长的请求："详细解释 DrawIO 图表的结构"
- [ ] **预期结果**：
  - 回复逐字出现（打字机效果）
  - 不是一次性显示完整内容
  - 加载状态正确显示

- [ ] **检查点**：
  - [ ] 流式输出流畅
  - [ ] 无卡顿
  - [ ] 消息自动滚动

### 场景 10：边界情况测试
**目标**：测试特殊情况

- [ ] 发送空消息 → 按钮应禁用
- [ ] 发送仅包含空格的消息 → 应被阻止
- [ ] 在 AI 回复时尝试发送新消息 → 按钮应禁用
- [ ] 快速连续发送多条消息 → 应排队处理
- [ ] 发送超长消息（1000+ 字符） → 应正常处理

---

## 调试检查清单

### Chrome DevTools
- [ ] 打开 Network 标签，观察 `/api/chat` 请求
  - [ ] 请求方法：POST
  - [ ] Content-Type: application/json
  - [ ] 请求体包含 `messages` 和 `llmConfig`
  - [ ] 响应为 SSE 流式格式

- [ ] 打开 Console 标签，检查日志
  - [ ] 开发环境下有详细的步骤日志
  - [ ] 工具调用有记录
  - [ ] 无意外错误

- [ ] 打开 Application 标签，检查 localStorage
  - [ ] `llmConfig` 存在且格式正确
  - [ ] `currentDiagram` 存在（如果有图表）

### 代码检查
- [ ] 运行 TypeScript 检查：
  ```bash
  npx tsc --noEmit
  ```
- [ ] 运行 Lint 检查：
  ```bash
  pnpm run lint
  ```
- [ ] 检查构建：
  ```bash
  pnpm run build
  ```

---

## 常见问题排查

### 问题 1：工具调用卡片不显示
**可能原因**：
- 消息结构不正确
- `toolInvocations` 字段不存在

**解决方法**：
- 检查 `useChat` 返回的 messages 结构
- 在渲染前打印 `console.log(messages)`

### 问题 2：工具执行失败
**可能原因**：
- localStorage 不可用
- XML 格式无效

**解决方法**：
- 检查浏览器控制台错误
- 验证 `drawio-tools.ts` 函数正常工作

### 问题 3：流式响应不工作
**可能原因**：
- API 路由未设置 Edge Runtime
- `toDataStreamResponse()` 未正确返回

**解决方法**：
- 确认 `route.ts` 顶部有 `export const runtime = 'edge';`
- 检查 API 路由返回值

### 问题 4：达到最大轮次后继续调用
**可能原因**：
- `maxSteps` 参数未生效
- AI SDK 版本问题

**解决方法**：
- 验证 `maxSteps: llmConfig.maxToolRounds`
- 检查 `ai` 包版本（应为 ^5.0.0）

---

## 验收标准

- [ ] 所有 10 个测试场景通过
- [ ] 无控制台错误或警告
- [ ] 用户体验流畅
- [ ] 错误提示清晰友好
- [ ] 工具调用过程可视化
- [ ] 配置切换正常工作
- [ ] 流式响应正常
- [ ] 边界情况处理正确
- [ ] 代码检查全部通过
- [ ] 构建成功

---

## 完成后

### 最终确认
- [ ] 所有里程碑任务完成
- [ ] 文档已更新
- [ ] 代码已提交到 git
- [ ] 功能演示视频或截图（可选）

### 后续优化方向
1. 添加消息历史管理（保存/加载对话）
2. 支持图片上传和分析
3. 添加更多 DrawIO 操作工具
4. 优化工具调用的 UI 展示
5. 添加工具调用的撤销/重做功能
6. 实现版本管理功能（之前的 TODO）

---

🎉 **恭喜！AI Agent Loop 功能开发完成！**

---

*最后更新: 2025-10-27*
